From f2218fcce4e7353f278f1992281b21a6a44d253e Mon Sep 17 00:00:00 2001
From: Daniel Leung <danielcp@gmail.com>
Date: Thu, 5 Mar 2020 14:30:36 -0800
Subject: [PATCH 7/7] gdb: xtensa: does not support 'g' packet

Signed-off-by: Daniel Leung <danielcp@gmail.com>
---
 gdb/configure     | 20 ++++++++++++++++++++
 gdb/configure.ac  | 14 ++++++++++++++
 gdb/xtensa-tdep.c | 12 ++++++++++++
 3 files changed, 46 insertions(+)

diff --git a/gdb/configure b/gdb/configure
index 250e7e0ea8..7ae52df526 100755
--- a/gdb/configure
+++ b/gdb/configure
@@ -912,6 +912,7 @@ enable_gdbserver
 with_babeltrace
 with_libbabeltrace_prefix
 enable_xtensa_use_target_regnum
+enable_xtensa_remote_g_packet
 with_xxhash
 with_libxxhash_prefix
 enable_unit_tests
@@ -1583,6 +1584,8 @@ Optional Features:
                           is auto)
   --enable-xtensa-use-target-regnum
                           Use remote target register numbers (Xtensa target)
+  --disable-xtensa-remote-g-packet
+                          Disable g packet for remote Xtensa target
   --enable-unit-tests     Enable the inclusion of unit tests when compiling
                           GDB
 
@@ -18420,6 +18423,23 @@ if test x"$enable_xtensa_use_target_regnum" = xyes; then
   CPPFLAGS="$CPPFLAGS -DXTENSA_USE_TGT_REGNUM"
 fi
 
+# Use g packet for remote Xtensa target
+# Check whether --enable-xtensa-remote-g-packet was given.
+if test "${enable_xtensa_remote_g_packet+set}" = set; then :
+  enableval=$enable_xtensa_remote_g_packet; case $enableval in
+    yes | no)
+      enable_xtensa_use_g_packet=$enableval ;;
+    *)
+      as_fn_error $? "bad value $enableval for --enable-xtensa-remote-g-packet" "$LINENO" 5 ;;
+  esac
+else
+  enable_xtensa_use_g_packet=yes
+fi
+
+if test x"$enable_xtensa_use_g_packet" = xno; then
+  CPPFLAGS="$CPPFLAGS -DXTENSA_DISABLE_REMOTE_G_PACKET"
+fi
+
 # Check for xxhash
 
 # Check whether --with-xxhash was given.
diff --git a/gdb/configure.ac b/gdb/configure.ac
index d889d2af0c..0ea27193f0 100644
--- a/gdb/configure.ac
+++ b/gdb/configure.ac
@@ -2181,6 +2181,20 @@ if test x"$enable_xtensa_use_target_regnum" = xyes; then
   CPPFLAGS="$CPPFLAGS -DXTENSA_USE_TGT_REGNUM"
 fi
 
+# Use g packet for remote Xtensa target
+AC_ARG_ENABLE(xtensa-remote-g-packet,
+AS_HELP_STRING([--disable-xtensa-remote-g-packet], [Disable g packet for remote Xtensa target]),
+  [case $enableval in
+    yes | no)
+      enable_xtensa_use_g_packet=$enableval ;;
+    *)
+      AC_MSG_ERROR([bad value $enableval for --enable-xtensa-remote-g-packet]) ;;
+  esac],
+  [enable_xtensa_use_g_packet=yes])
+if test x"$enable_xtensa_use_g_packet" = xno; then
+  CPPFLAGS="$CPPFLAGS -DXTENSA_DISABLE_REMOTE_G_PACKET"
+fi
+
 # Check for xxhash
 AC_ARG_WITH(xxhash,
   AC_HELP_STRING([--with-xxhash], [use libxxhash for hashing (faster) (auto/yes/no)]),
diff --git a/gdb/xtensa-tdep.c b/gdb/xtensa-tdep.c
index 7d9e0c7d31..bc1078336d 100644
--- a/gdb/xtensa-tdep.c
+++ b/gdb/xtensa-tdep.c
@@ -3158,6 +3158,16 @@ xtensa_remote_register_number (struct gdbarch *gdbarch, int regnum)
 }
 #endif
 
+int
+xtensa_remote_supports_g_packet (struct gdbarch *gdbarch)
+{
+#ifdef XTENSA_DISABLE_REMOTE_G_PACKET
+  return 0;
+#else
+  return 1;
+#endif
+}
+
 /* Module "constructor" function.  */
 
 extern struct gdbarch_tdep xtensa_tdep;
@@ -3258,6 +3268,8 @@ xtensa_gdbarch_init (struct gdbarch_info info, struct gdbarch_list *arches)
   set_solib_svr4_fetch_link_map_offsets
     (gdbarch, svr4_ilp32_fetch_link_map_offsets);
 
+  set_gdbarch_remote_supports_g_packet (gdbarch, xtensa_remote_supports_g_packet);
+
   /* Hook in the ABI-specific overrides, if they have been registered.  */
   gdbarch_init_osabi (info, gdbarch);
 
-- 
2.26.2

